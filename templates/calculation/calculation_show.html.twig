{% extends 'cards/card_show.html.twig' %}
{# imports #}
{% import 'macros/_icons.html.twig' as icons %}
{% import 'macros/_properties.html.twig' as properties %}

{# macro #}
{% macro propertyDateUser(name, date, user) -%}
{% set created_date = date ? date|localedatetime : 'common.empty_date'|trans %}
{% set created_user = user|default('common.empty_user'|trans) -%}
{{ properties.property(name, created_date ~ ' - ' ~ created_user) }}
{%- endmacro %}

{# parameters #}
{%- set id = item.id -%}
{%- set title = 'calculation.show.title' -%}
{%- set params = route_params(app.request, id) %}

{# actions #}
{%- set list_path = app.displayTabular ? 'calculation_table' : 'calculation_card' -%}
{%- set edit_path = is_granted(ATTRIBUTE_EDIT, item) and item.editable ? path('calculation_edit', params) : null -%}
{%- set delete_path = is_granted(ATTRIBUTE_DELETE, item) ? path('calculation_delete', params) : null -%}
{%- set cancel_path = cancel_url(app.request, id, list_path) -%}
{%- set pdf_export = is_granted(ATTRIBUTE_EXPORT, item) -%}

{% block card_header_class ' d-print-none' %}
{% block card_container_class '' %}
{% block card_body_class '' %}

{% block property_header %}{# no header #}{% endblock %}

{% block card_body %}
{{ parent() }}
{% if not item.empty %}
<table class="table table-hover table-sm table-list mt-3" id="data-table-edit">
    <tbody>
        {# groups #}
        {% for group in item.groups %}
        <tr>
            <th colspan="5">{{ group.code }}</th>
        </tr>
        {# categories #}
        {% for category in group.categories %}
        <tr>
            <th class="pl-3" colspan="5">{{ category.code }}</th>
        </tr>
        {# items #}
        {% for product in category.items %}
        <tr>
            <td class="pl-3">{{ product.description }}</td>
            <td class="text-unit">{{ product.unit }}</td>
            <td class="text-currency">{{ product.price|amount }}</td>
            <td class="text-currency">{{ product.quantity|amount }}</td>
            <td class="text-currency">{{ product.total|amount }}</td>
        </tr>
        {% endfor %}
        {% endfor %}
        {% endfor %}
        {# items total #}
        <tr>
            <td class="font-weight-bold" colspan="4">{{ 'calculation.fields.itemsTotal'|trans }}</td>
            <td class="font-weight-bold text-currency">{{ item.groupsAmount|amount }}</td>
        </tr>
    </tbody>
</table>

{# totals #}
<table class="table table-hover table-sm table-list mt-3 mb-0">
    <thead>
        <tr>
            <th>{{ 'calculation.edit.panel_resume'|trans }}</th>
            <th class="text-currency">{{ 'report.calculation.amount'|trans }}</th>
            <th class="text-percent">{{ 'report.calculation.margin_percent'|trans }}</th>
            <th class="text-currency">{{ 'report.calculation.margin_amount'|trans }}</th>
            <th class="text-currency">{{ 'report.calculation.total'|trans }}</th>
        </tr>
    </thead>
    <tbody>
        {# total by group #}
        {% for group in item.groups %}
            <tr>
                <td>{{ group.code }}</td>
                <td class="text-currency">{{ group.amount|amount }}</td>
                <td class="text-percent">{{ group.margin|percent }}</td>
                <td class="text-currency">{{ group.marginAmount|amount }}</td>
                <td class="text-currency">{{ group.total|amount }}</td>
            </tr>
        {% endfor %}

        {# groups total #}
        <tr>
            <td class="font-weight-bold">{{ 'calculation.fields.marginTotal'|trans }}</td>
            <td class="text-currency">{{ item.groupsAmount|amount }}</td>
            <td class="text-percent">{{ item.groupsMargin|percent }}</td>
            <td class="text-currency">{{ item.groupsMarginAmount|amount }}</td>
            <td class="font-weight-bold text-currency">{{ item.groupsTotal|amount }}</td>
        </tr>

        {# global margin #}
        <tr>
            <td colspan="2">{{ 'calculation.fields.globalMargin'|trans }}</td>
            <td class="text-percent">{{ item.globalMargin|percent }}</td>
            <td colspan="2" class="text-currency">{{ item.globalMarginAmount|amount }}</td>
        </tr>

        {# user margin #}
        {% if item.userMargin != 0 %}
            <tr>
                <td class="font-weight-bold" colspan="4">{{ 'calculation.fields.totalNet'|trans }}</td>
                <td class="font-weight-bold text-currency">{{ item.totalNet|amount }}</td>
            </tr>
            <tr>
                <td colspan="2">{{ 'calculation.fields.userMargin'|trans }}</td>
                <td class="text-percent">{{ item.userMargin|percent }}</td>
                <td colspan="2" class="text-currency">{{ item.userMarginAmount|amount }}</td>
            </tr>
        {% endif %}

        {# overall total #}
        <tr>
            <td class="font-weight-bold">{{ 'calculation.fields.overallTotal'|trans }}</td>
            <td class="font-weight-bold text-currency">{{ item.groupsAmount|amount }}</td>
            {%- if app.marginBelow(item) -%}
                {%- set margin_below_title = 'calculation.list.margin_below'|trans({'%margin%': item.overallMargin|percent, '%minimum%': min_margin|percent}) -%}
                <td class="font-weight-bold text-currency text-danger has-tooltip" data-html="true" title="{{ margin_below_title }}">{{ item.overallMargin|percent }}</td>
            {%- else -%}
                <td class="font-weight-bold text-currency">{{ item.overallMargin|percent }}</td>
            {%- endif -%}
            <td class="font-weight-bold text-currency">{{ item.overallMarginAmount|amount }}</td>
            <td class="font-weight-bold text-currency">{{ item.overallTotal|amount }}</td>
        </tr>
    </tbody>
</table>
{% endif %}
{% endblock %}

{# properties #}
{% block property_body %}
{{ properties.property('calculation.fields.id', id|identifier, 'font-weight-bold') }}
{{ properties.property('calculation.fields.customer', item.customer) }}
{{ properties.property('calculation.fields.description', item.description) }}
{{ properties.property('calculation.fields.date', item.date|localedate) }}
{{ properties.property('calculation.fields.state', item.stateCode|default('')) }}
{{ _self.propertyDateUser('calculation.fields.created', item.createdAt, item.createdBy) }}
{{ _self.propertyDateUser('calculation.fields.updated', item.updatedAt, item.updatedBy) }}
{% if item.empty %}
    {{ properties.property('calculation.edit.panel_items', 'calculation.edit.empty'|trans) }}
{% endif %}
{% endblock %}

{% block card_footer %}
<div class="row">
    <div class="col-md-8">
    {{ parent() }}
    {%- if pdf_export -%}
        {{ icons.button_pdf('calculation_pdf_id', {'id': id}) }}
    {%- endif -%}
    </div>
    <div class="col-md-4 text-md-right">
        <p id="error-all" class="mb-0" class="d-none">
            <span id="error-duplicate" class="d-none"><span class="duplicate-cell"></span>{{ 'duplicate.title'|trans }}</span>
            <span id="error-empty" class="d-none ml-1"><span class="empty-cell"></span>{{ 'empty.title'|trans }}</span>
        </p>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{% if app.debug %}
{{ parent() }}
{{ asset_js('js/application/calculation_error.js') }}
{% else %}
{{ asset_js('js/calculation_error.js') }}
{% endif %}
{% endblock %}
