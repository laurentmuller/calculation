name: Continuous Integration

on: [ push, pull_request ]

env:
    PHP_CS_FIXER_IGNORE_ENV: 1

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Install PHP with extensions
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.2'
                    coverage: none

            -   name: Determine composer cache directory
                id: composer-cache
                run: echo "directory=$(composer config cache-dir)" >> $GITHUB_OUTPUT

            -   name: Cache dependencies installed with composer
                uses: actions/cache@v4
                with:
                    path: ${{ steps.composer-cache.outputs.directory }}
                    key: composer-${{ runner.os }}-${{ hashFiles('composer.*') }}
                    restore-keys: composer-${{ runner.os }}-composer-

            -   name: Install dependencies
                run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            -   name: Run PHP CS Fixer
                if: always() && steps.install.outcome == 'success'
                run: vendor/bin/php-cs-fixer fix --diff --dry-run --verbose

            -   name: Run PHPStan
                if: always() && steps.install.outcome == 'success'
                run: vendor/bin/phpstan analyze --no-progress

            -   name: Run Psalm
                if: always() && steps.install.outcome == 'success'
                run: vendor/bin/psalm --config=psalm.xml

            -   name: Run Rector
                if: always() && steps.install.outcome == 'success'
                run: vendor/bin/rector process --dry-run

            -   name: Run Twigcs
                if: always() && steps.install.outcome == 'success'
                run: vendor/bin/twigcs --config .twig_cs.dist.php
