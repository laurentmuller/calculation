{% extends 'cards/card_base.html.twig' %}
{% import 'macros/_icons.html.twig' as icons %}

{# imports #}
{% import 'macros/_datatables.html.twig' as helper %}

{# macros #}
{% macro button(path, text, class, title, icon) %}
{% if path %}
    <a href="#" class="btn btn-sm btn-form-sm {{ class }}" data-path="{{ path }}"{% if title %} title="{{ title|trans }}"{% endif %}{% if icon %} data-icon="{{ icon }}"{% endif %}>
        {{- text|trans -}}
    </a>
{% endif %}
{% endmacro %}

{% macro item_data(path, text, icon, attributes = {}) %}
{% if path %}
    <a href="#" data-path="{{ path }}" class="dropdown-item"{{ helper.attribs(attributes) }}>
        {{ icons.icon(icon ~ ' fa-fw', text) }}    	
    </a>
{% endif %}
{% endmacro %}

{% macro item_data_external(path, text, icon) %}
{% if path %}
    <a href="#" data-path="{{ path }}" class="dropdown-item" target="_blank" rel="noopener noreferrer">
        {{ icons.icon(icon ~ ' fa-fw', text) }}    	
    </a>
{% endif %}
{% endmacro %}

{% macro item_external(path, text, class, icon) %}
{% if path %}
    <a href="{{ path }}" target="_blank" rel="noopener noreferrer" class="{{ class }}">
        {{ icons.icon(icon ~ ' fa-fw', text) }}
	</a>
{% endif %}
{% endmacro %}

{# parameters #}
{%- set object_type   = object_type|default('none') -%}
{%- set ajax_path     = path(app.request.get('_route')) -%}
{%- set ajax_lang     = path('ajax_language') -%}
{%- set show_search   = (show_search is defined ? show_search : true) and results.recordsTotal > 10 -%}
{%- set show_length   = (show_length is defined ? show_length : true) and results.recordsTotal > 10 -%}

{%- set id            = app.request.get('id', 0) -%}
{%- set ordercolumn   = app.session.get(object_type ~ '.ordercolumn') -%}
{%- set orderdir      = app.session.get(object_type ~ '.orderdir') -%}
{%- set pagelength    = app.session.get(object_type ~ '.pagelength', 15) -%}

{%- set is_pdf_action = pdf_path|default(false) and is_granted(IEntityVoter.ATTRIBUTE_PDF, object_type) -%}
{%- set other_actions = is_pdf_action or other_actions|default(false) -%}

{# classes #}
{% block card_container_class '' %}
{% block card_body_class 'px-3 pb-0 pt-2' %}
{% block card_footer_class 'd-none' %}

{% block card_header %}
<div class="row">
	<div class="col-lg-5 mt-1">{{ parent() }}</div>
	<div class="col-lg-7 text-lg-right d-print-none">
        {# actions toolbar #}
		<div class="btn-group" role="group" aria-label="{{ 'common.actions'|trans }}">
            {% if add_path|default(false) and is_granted(IEntityVoter.ATTRIBUTE_ADD, object_type) %}
                {{ _self.button(add_path|default(false), 'common.button_add', 'btn-table-add btn-primary', add_title|default(false), 'far fa-fw fa-file') }}
            {% endif %}
            {% if show_path|default(false) and is_granted(IEntityVoter.ATTRIBUTE_SHOW, object_type) %}
                {{ _self.button(show_path|default(false), 'common.button_show', 'btn-table-show btn-info disabled', show_title|default(false), 'far fa-fw fa-list-alt') }}
            {% endif %}
    		{% if edit_path|default(false) and is_granted(IEntityVoter.ATTRIBUTE_EDIT, object_type) %}
                {{ _self.button(edit_path|default(false), 'common.button_edit', 'btn-table-edit btn-success disabled', edit_title|default(false), 'fas fa-fw fa-pencil-alt') }}
            {% endif %}
            {% if delete_path|default(false) and is_granted(IEntityVoter.ATTRIBUTE_DELETE, object_type) %}
                {{ _self.button(delete_path|default(false),'common.button_delete', 'btn-table-delete btn-danger disabled', delete_title|default(false), 'fas fa-fw fa-times') }}
            {% endif %}
            {% block other_actions -%}
			{%- if other_actions -%}	   
			<div class="btn-group" role="group" aria-label="{{ 'common.other_actions'|trans }}">
                <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="{{ 'common.other_actions'|trans }}">
                    <i class="fas fa-bars" aria-hidden="true"></i>
                </button>
    	    	<div class="dropdown drop-down-actions">
    	    		<div class="dropdown-menu dropdown-menu-right">
    	    			{% block table_actions -%}
                        {% if is_pdf_action %}
                            {% set pdf_title = pdf_title|default('common.button_pdf_list') %}
                            {{ _self.item_external(pdf_path|default(false), pdf_title, 'dropdown-item btn-pdf-list', 'file-pdf far') }}
                        {% endif %}
                        {%- endblock %}
    	    		</div>
    	    	</div>
			</div>            
			{%- endif -%}
            {%- endblock %}
		</div>
	</div>
</div>
{% endblock %}

{% block card_body %}
{% if show_length or show_search -%}
<div class="row mb-2 d-print-none">
    {# search #}
    {% if show_search -%}
    <div class="col-auto mr-auto">
        <div class="form-inline">
             <label class="mr-2" for="table_search">{{ 'datatable.search'|trans }}</label>
             <div class="input-group input-group-sm bg-white">
                <input type="text" id="table_search" name="table_search" class="form-control form-control-sm form-control-border-right-0" autocomplete="off">
                <div class="input-group-append">
                    <button type="button" class="btn btn-clear btn-outline-secondary border border-left-0" title="{{ 'datatable.clear'|trans }}">
                        <i class="fas fa-eraser" aria-hidden="true"></i>
                    </button>
                </div>
             </div>
             {% block show_length_actions -%}{%- endblock %}
        </div>
    </div>
    {%- endif %}
    {# elements to display #}
    {% if show_length -%}
    <div class="col-auto{% if not show_search %} ml-auto{% endif %}">
        <div class="form-inline">
            <label class="mr-2" for="table_length">{{ 'datatable.show'|trans }}</label>
            <select id="table_length" name="table_length" class="form-control form-control-sm custom-select custom-select-sm">
                {{ helper.page(10, pagelength) }}
                {% if results.recordsTotal > 10 %}{{ helper.page(15, pagelength) }}{% endif %}
                {% if results.recordsTotal > 15 %}{{ helper.page(20, pagelength) }}{% endif %}
                {% if results.recordsTotal > 20 %}{{ helper.page(25, pagelength) }}{% endif %}
                {% if results.recordsTotal > 25 %}{{ helper.page(30, pagelength) }}{% endif %}
                {% if results.recordsTotal > 30 %}{{ helper.page(50, pagelength) }}{% endif %}
                {% if results.recordsTotal > 50 %}{{ helper.page(-1, pagelength, 'datatable.all') }}{% endif %}
            </select>
            <label class="ml-2">{{ 'datatable.elements'|trans }}</label>
        </div>    
    </div>
    {%- endif %}
</div>
{%- endif %}

{%- set attributes = attributes|default({})|merge ({
        'id': 'data-table',
        'class': 'table table-list table-hover table-sm dataTable border-bottom w-100',
        'data-ajax': ajax_path,
        'data-lang': ajax_lang,
        'data-total': results.recordsTotal,
        'data-filtered': results.recordsFiltered,
        'data-pagelength': pagelength,        
        'data-ordercolumn': ordercolumn,
      	'data-orderdir': orderdir,
        'data-debug': app.debug
}) -%}
<table{{ helper.attribs(attributes) }}>
    {{ helper.headers(columns) }}
    <tbody>
        {% for row in results.data -%}
	        <tr{% if row[0] == id %} class="datatables-selection"{% endif %}>
    	    {% for cell in row -%}
        		<td class="{{ columns[loop.index0].cellClassName }}">{{ columns[loop.index0].rawData ? cell|raw : cell }}</td>
            {%- endfor %}
			</tr>
		{%- endfor %}
    </tbody>
</table>
{% endblock %}

{% block stylesheets %}
{{ asset_css('css/datatables.css') }}
{%- endblock -%}

{% block javascripts -%}
{% if app.debug %}
{{ parent() }}
{# DataTables #}
{{ asset_js('js/vendor/datatables/js/jquery.dataTables.js') }}
{{ asset_js('js/vendor/datatables/js/dataTables.bootstrap4.js') }}
{{ asset_js('js/vendor/datatables/js/dataTables.keyTable.js') }}
{{ asset_js('js/vendor/datatables/js/dataTables.conditionalPaging.js') }}
{{ asset_js('js/vendor/datatables/js/jquery.highlight.js') }}
{{ asset_js('js/vendor/datatables/js/dataTables.searchHighlight.js') }}
{{ asset_js('js/vendor/contextmenu/jquery.contextMenu.js') }}
{{ asset_js('js/app/extensions/contextmenu-extensions.js') }}
{{ asset_js('js/app/extensions/datatables-extensions.js') }}
{{ asset_js('js/app/datatables.js') }}
{% else %}
{{ asset_js('js/datatables.js') }}
{% endif %}
{%- endblock -%}
