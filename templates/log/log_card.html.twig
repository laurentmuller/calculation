{% extends 'cards/card_base.html.twig' %}

{# imports #}
{% import 'macros/_icons.html.twig' as icons %}
{% import 'log/_macro_log.html.twig' as tools %}

{# macros #}
{% macro card(key, value, border, type) %}
<div class="card text-center {% if border %}{{ 'selection ' ~ border }}{% endif %}"
    {% if border %}data-border="{{ border }}"{% endif %}
    {% if type %}data-type="{{ type }}"{% endif %}
    data-key="{{ key }}">
    <div class="card-body p-0 mt-1">
        <div class="h4 font-weight-normal">{{ value|integer }}</div>
    </div>
    <div class="card-footer p-1">
        <small class="card-text">{{ key|capitalize }}</small>
    </div>
</div>
{% endmacro %}

{# parameters #}
{%- set title = 'log.title' -%}
{%- set title_icon = 'book' -%}

{% block card_container_class %}
{% if logs is empty %}{{ parent() }}{% endif %}
{% endblock %}
{% block card_body_class ' p-2 pb-0' %}
{% block card_footer_class ' d-none' %}

{% block card_header %}
<div class="row">
    <div class="col-md-8">
        {{- parent() -}}
    </div>
    <div class="col-md-4 text-md-right">
        <div id="actions" class="btn-group btn-group-sm" role="group" aria-label="{{ 'common.actions'|trans }}">
            <button id="actions_button" class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="{{ 'common.actions'|trans }}">
                <i class="fas fa-bars" aria-hidden="true"></i>
            </button>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="actions_button">
                {{ icons.dropdownItemWithClass(path('log_pdf'), 'log.list.pdf_title', 'file-pdf far', 'btn-pdf') }}
                {{ icons.dropdownItem(path('log_delete', {'route': app.request.get('_route')}), 'log.delete.title', 'times') }}
                {{ icons.dropdownSeparator() }}
                {{ icons.dropdownItem(path('log_refresh', {'route': app.request.get('_route')}), 'common.button_refresh', 'sync-alt') }}
                {{ icons.dropdownSeparator() }}
                {{ icons.dropdownItemTable('log_table') }}
            </div>
        </div>
    </div>
</div>
{% if logs is empty %}
    <small class="ml-3">{{ 'log.list.file'|trans({'%file%': file}) }}</small>
{% else %}
    <div class="row">
        <div class="col-md-8">
            <small class="ml-3">{{ 'log.list.file'|trans({'%file%': file}) }}</small>
        </div>
        <div class="col-md-4 text-md-right">
             <small id="overall_total" data-text="{{ 'common.count'|trans }}">
                {{- 'common.count'|trans({'%count%': logs|length|integer}) -}}
             </small>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block card_body %}
{% if logs %}
{# counters #}
<div id="cards" class="card-deck mb-2">
    {# level #}
    {% for key, value in levels %}
        {{ _self.card(key, value, key, 'level') }}
    {% endfor %}
    <div style="background: #dee2e6; width: 1px;"></div>
    {# channel #}
    {% for key, value in channels %}
        {{ _self.card(key, value, 'border-dark', 'channel') }}
    {% endfor %}
</div>
{# logs #}
<table id="logs" class="table table-hover table-sm mb-0">
    <thead>
        <tr>
            <th class="date">{{ 'log.fields.createdAt'|trans }}</th>
            <th class="level">{{ 'log.fields.level'|trans }}</th>
            <th class="channel">{{ 'log.fields.channel'|trans }}</th>
            <th>{{ 'log.fields.message'|trans }}</th>
        </tr>
    </thead>
    <tbody>
    {% for line in logs %}
        <tr class="{{ line.level ~ ' ' ~ line.channel }}">
            <td class="date {{ line.level }}">{{ line.createdAt|localedatetime(null, 'medium') }}</td>
            <td class="level"> {{ line.level|capitalize }}</td>
            <td class="channel">{{ line.channel|capitalize }}</td>
            <td class="message">
                {%- if line.channel == 'doctrine' -%}
                    {{- line.message|doctrine_format_sql(true) -}}
                {%- else -%}
                    {{- line.message|raw|nl2br -}}
                {%- endif -%}                
                {%- if line.context|length -%}
                    <pre class="text-break text-success white-space-pre-wrap mb-0">{{- tools.format_var(line.context) -}}</pre>
                {%- endif -%}
                {%- if line.extra|length -%}
                    <pre class="text-break text-success white-space-pre-wrap mb-0">{{- tools.format_var(line.extra) -}}</pre>
                {%- endif -%}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p class="m-3 text-danger text-center">{{ 'log.list.empty'|trans }}</p>
{% endif %}
{% endblock %}

{% block stylesheets %}
{{ asset_css('css/log.css') }}
{% endblock %}

{% block javascripts %}
{% if app.debug %}
{{ parent() }}
{{ asset_js('js/application/log_card.js') }}
{% else %}
{{ asset_js('js/log_card.js') }}
{% endif %}
{% endblock %}
